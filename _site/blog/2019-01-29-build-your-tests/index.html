<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>How to build in your tests</title><meta name="description" content="or: How I learned to get the most out of copying"><link rel="stylesheet" type="text/css" href="/static/css/style.css"><link rel="stylesheet" type="text/css" href="/static/css/prism-tomorrow.css"></head><body><div class="container max-w-4xl mt-6 px-6"><div class="pb-5 mb-5 border-b border-gray-100"><h1 class="font-bold text-5xl">How to build in your tests</h1><p class="text-center text-base leading-6 font-medium text-gray-500"><time>01 May 2019 by <a></a></time></p></div><article class="prose lg:prose-xl my-4 mx-auto"><p>When writing automated tests you end up with a lot of similar code. Objects repeat with slight variations each time. Using the data builder pattern can help reduce boilerplate and let those variations leap out.</p><p>It was this series of <a href="http://blog.ploeh.dk/2017/08/15/test-data-builders-in-c/">blog posts</a> by Mark Seemann that introduced me to the idea of test data builders.</p><h3>What is a test data builder?</h3><p>A data builder is a &quot;copy with&quot; tool. The data builder &quot;copies&quot; an object and then can update specified properties &quot;with&quot; new data. The pattern is simple enough to achieve with modern JavaScript and rest parameters.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> baseObj <span class="token operator">=</span> <span class="token punctuation">{</span><br>  count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>  property<span class="token operator">:</span> <span class="token string">"Hi"</span><br><span class="token punctuation">}</span><br><span class="token keyword">const</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>baseObj<span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code></pre><p>We end up with two separate objects both that are structurally the same but with a single variation between them.</p><h3>How is a data builder useful?</h3><p>Lets start with a <code>foo</code> function <code>bigObject -&gt; result</code> we want to test. We pass our bigObject into the function and get a result at the end. To test this we would have something like this:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> bigObject <span class="token operator">=</span> <span class="token punctuation">{</span>   <br>  first<span class="token operator">:</span> <span class="token string">"here is the first param"</span><span class="token punctuation">,</span><br>  last<span class="token operator">:</span> <span class="token string">"here is the last param"</span><span class="token punctuation">,</span><br>  howManyParams<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span><br>  subtle<span class="token operator">:</span> <span class="token string">"not so different"</span><span class="token punctuation">,</span><br>  isBig<span class="token operator">:</span> <span class="token boolean">true</span>  <br><span class="token punctuation">}</span><br><span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span>bigObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>expectedResult<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>When we get to our second test we start by creating another <code>bigObject</code> this time with one parameter different. Now we are in spot the difference territory, the two tests look almost identical but with one small difference in the <code>secondbigObject</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> bigObject <span class="token operator">=</span> <span class="token punctuation">{</span> <br>  first<span class="token operator">:</span> <span class="token string">"here is the first param"</span><span class="token punctuation">,</span><br>  last<span class="token operator">:</span> <span class="token string">"here is the last param"</span><span class="token punctuation">,</span><br>  howManyParams<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span><br>  subtle<span class="token operator">:</span> <span class="token string">"not so different"</span><span class="token punctuation">,</span><br>  isBig<span class="token operator">:</span> <span class="token boolean">true</span> <br><span class="token punctuation">}</span><br><span class="token keyword">const</span> secondBigObject <span class="token operator">=</span> <span class="token punctuation">{</span> <br>  first<span class="token operator">:</span> <span class="token string">"here is the first param"</span><span class="token punctuation">,</span><br>  last<span class="token operator">:</span> <span class="token string">"here is the last param"</span><span class="token punctuation">,</span><br>  howManyParams<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span><br>  subtle<span class="token operator">:</span> <span class="token string">"difference"</span><span class="token punctuation">,</span><br>  isBig<span class="token operator">:</span> <span class="token boolean">true</span> <br><span class="token punctuation">}</span><br><br><span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span>bigObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>expectedResult<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span>secondBigObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>secondExpectedResult<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The difference between the two objects is subtle and not easy to spot. Lets see how this looks when we use our simple copy with technique:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> baseObject <span class="token operator">=</span> <span class="token punctuation">{</span> <br>  first<span class="token operator">:</span> <span class="token string">"here is the first param"</span><span class="token punctuation">,</span><br>  last<span class="token operator">:</span> <span class="token string">"here is the last param"</span><span class="token punctuation">,</span><br>  howManyParams<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span><br>  subtle<span class="token operator">:</span> <span class="token string">"not so different"</span><span class="token punctuation">,</span><br>  isBig<span class="token operator">:</span> <span class="token boolean">true</span> <br><span class="token punctuation">}</span><br><span class="token keyword">const</span> secondBigObject <span class="token operator">=</span> <span class="token punctuation">{</span> <br>  <span class="token operator">...</span>baseObject<span class="token punctuation">,</span><br>  subtle<span class="token operator">:</span> <span class="token string">"difference"</span><br><span class="token punctuation">}</span><br><br><span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span>baseObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>expectedResult<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span>secondBigObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>secondExpectedResult<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The change is so much clearer to see now. The second test is against the baseObject with a <code>subtle: &quot;difference&quot;</code>. The importance of being able to quickly see and compare tests can save a lot of time and mental overhead. It also makes it easier to keep the test descriptions up to date.</p><h3>Change happens</h3><p>Another advantage of using the &quot;copy with&quot; technique is when it comes time to extend or refactor. Lets say we realise our <code>isBig</code> property is not actually boolean, but rather an enumeration. We need to change <code>isBig: boolean</code> to <code>sizeState: &quot;Big&quot; | &quot;Small&quot; | &quot;Relative&quot;</code>.</p><p>In the full objects everywhere world the refactoring would involve changing every object, and making sure that each &quot;true&quot; became &quot;Big&quot; and each &quot;false&quot; became &quot;Small&quot;. Having to make a change to every test that uses this object can be a source of risk. While at the same time changing tests that may not even be testing the refactored property.</p><p>In our &quot;copy with&quot; technique world, we change our base object. Setting <code>sizeState: &quot;Big&quot;</code> This will cover all the tests for one of the cases and all of the tests where the property is not used. Then anywhere where <code>isBig</code> is <code>false</code> that can be changed to <code>sizeState: &quot;Small&quot;</code></p><p>Finally we can extend our tests to cover the new state <code>&quot;Relative&quot;</code>.</p><h3>As a function</h3><p>If we want to we can wrap up the data builder into a function, with a builder pattern.</p><p>A TypeScript implementation below:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">type</span> <span class="token class-name">PartialObj<span class="token operator">&lt;</span>Obj <span class="token keyword">extends</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Prop <span class="token keyword">in</span> <span class="token keyword">keyof</span> Obj<span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> Obj<span class="token punctuation">[</span>Prop<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">dataBuilderFactory</span><span class="token generic class-name"><span class="token operator">&lt;</span>Obj <span class="token keyword">extends</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>obj<span class="token operator">:</span> Obj<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span><br>    <span class="token function-variable function">with</span><span class="token operator">:</span> <span class="token punctuation">(</span>partial<span class="token operator">:</span> PartialObj<span class="token operator">&lt;</span>Obj<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> updateObj <span class="token operator">=</span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span><span class="token punctuation">(</span>obj <span class="token keyword">as</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token operator">...</span><span class="token punctuation">(</span>partial <span class="token keyword">as</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span> <span class="token keyword">as</span> Obj<span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token function">dataBuilderFactory</span><span class="token punctuation">(</span>updateObj<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token function-variable function">build</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token punctuation">(</span>obj <span class="token keyword">as</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> Obj<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>and then some examples of how to use it:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">interface</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><br>  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><br>  dob<span class="token operator">:</span> Date<span class="token punctuation">;</span><br>  tel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">personBuilder</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token generic-function"><span class="token function">dataBuilderFactory</span><span class="token generic class-name"><span class="token operator">&lt;</span>Person<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> <span class="token string">"test name"</span><span class="token punctuation">,</span><br>  dob<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  tel<span class="token operator">:</span> <span class="token string">"555-12345"</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> adam <span class="token operator">=</span> <span class="token function">personBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    name<span class="token operator">:</span> <span class="token string">"Adam"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> partialDoc <span class="token operator">=</span> <span class="token function">personBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    name<span class="token operator">:</span> <span class="token string">"Doc Brown"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> docBorn1985<span class="token operator">=</span> partialDoc <br>  <span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    dob<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">1985</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br><span class="token keyword">const</span> docBorn1885 <span class="token operator">=</span> partialDoc <br>  <span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    dob<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">1885</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>This is useful with simple objects, when you want to go one level deep. With more complex objects and structures tools for immutability become much more useful.</p><h3>The power of test data builders</h3><p>The reason I think test data builders are so important is they give you two fold, allow you to quickly focus on the difference between test; and to allow easy refactoring. These are two areas that have caused me pain when it comes to testing. So a test data builder is one of the tools I reach for early and often when it comes to writing tests.</p></article></div><footer><nav><div><div><img src="https://www.gravatar.com/avatar/7b1630c267230ec687dd7133d3a2e2b3?s=80" class="logo__img" alt="Adam Sanderson"></div>A front-end developer based out of Hastings, UK</div><a href="/">Home<a href="https://github.com/adsanderson" title="Github"> github </a><a href="https://twitter.com/lazydayed" title="Twitter">twitter </a><a href="mailto:adam+site@adamsanderson.co.uk" rel="me">email</a></a></nav></footer><script src="/static/js/alpine.js"></script></body></html>