<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Slotting into Preact</title><meta name="description" content="or: How I learned the root of all things"><link rel="stylesheet" type="text/css" href="/static/css/style.css"><link rel="stylesheet" type="text/css" href="/static/css/prism-tomorrow.css"></head><body><div class="container max-w-4xl mt-6 px-6"><div class="pb-5 mb-5 border-b border-gray-100"><h1 class="font-bold text-5xl">Slotting into Preact</h1><p class="text-center text-base leading-6 font-medium text-gray-500"><time>12 Feb 2019 by <a></a></time></p></div><article class="prose lg:prose-xl my-4 mx-auto"><p>Preact is an excellent UI library and web components make a fantastic building block. But, I have found one stumbling block that relates to the <code>&lt;slot&gt;</code> element in browsers without the shadow DOM and using the a polyfill.</p><h3>The issue</h3><p>The issue is after an update content appears twice, once as expected and then the same DOM content but usually styled slightly differently.</p><p>What is happening is the polyfill will move content so it no longer matches the VDOM internal to Preact.</p><h3>What is happening</h3><p>When you use a web component using shadow DOM and has a slot you would write something like this:</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-element</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Some heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-element</span><span class="token punctuation">></span></span></code></pre><p>The next step is for the web components polyfill to initialise the custom element and add in the additional DOM.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-element</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>custom-element__wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Some heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-element</span><span class="token punctuation">></span></span></code></pre><p>The polyfill then moves the child elements fro the custom element node and places them inside the additional DOM of the custom element.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-element</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>custom-element__wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Some heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-element</span><span class="token punctuation">></span></span></code></pre><p>When an update occurs in Preact this is where the issue occurs. Preact will diff it's derived V-DOM against the actual DOM and find that the the custom elements child content is missing from it's root and will then insert it.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-element</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>custom-element__wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Some heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span> <br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Some heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-element</span><span class="token punctuation">></span></span></code></pre><p>What appears in the actual DOM and the screen is the content of the custom element doubling up, usually with different styling.</p><h3>The solution(s)</h3><p>There are a number of ways to mitigate the impact this has, first:</p><h4>Move the slot</h4><p>If you have control over the web component then to try and have slots in the root of the components template. If the content does not need moving then the component's output and Preact's VDOM will match in terms of structure.</p><p>This is not always possible, for example your design system button will want to use an actual button under the hood to take advantage of it's semantic meaning.</p><h4>Targeted updates</h4><p>Using the component life-cycle method <code>shouldComponentUpdate</code> lets you control when changes occur. This means when an update is triggered higher in the tree of the application you can check to see if the props passed to the custom element have changed and then if they are the same then stop the update process. Stopping the VDOM and actual DOM diffing against each other.</p><p>Then when you do need to update then it's best to:</p><h4>Blow it away</h4><p>If an update does need to occur then it is best to rerender the entire component rather than try and update the child elements.</p><p>The easiest way to do this to define the element within the render method, or if you are using an external Preact component to bind the component within the render method.</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ExistingComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./excistingComponent"</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> RerenderComponent <span class="token operator">=</span> <span class="token function">ExistingComponent</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></article></div><footer><nav><div><div><img src="https://www.gravatar.com/avatar/7b1630c267230ec687dd7133d3a2e2b3?s=80" class="logo__img" alt="Adam Sanderson"></div>A front-end developer based out of Hastings, UK</div><a href="/">Home<a href="https://github.com/adsanderson" title="Github"> github </a><a href="https://twitter.com/lazydayed" title="Twitter">twitter </a><a href="mailto:adam+site@adamsanderson.co.uk" rel="me">email</a></a></nav></footer><script src="/static/js/alpine.js"></script></body></html>