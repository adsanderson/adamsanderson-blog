<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>First steps in Model-based testing</title><meta name="description" content="or: How I learned to generate tests"><link rel="stylesheet" type="text/css" href="/static/css/style.css"><link rel="stylesheet" type="text/css" href="/static/css/prism-tomorrow.css"></head><body><div class="container max-w-4xl mt-6 px-6"><div class="pb-5 mb-5 border-b border-gray-100"><h1 class="font-bold text-5xl">First steps in Model-based testing</h1><p class="text-center text-base leading-6 font-medium text-gray-500"><time>03 Apr 2019 by <a></a></time></p></div><article class="prose lg:prose-xl my-4 mx-auto"><p>Model-based testing is the process of creating a model (an abstract version) of the behaviour of a system. Then executing the model so it is run over an implementation. Then validating that the system under tests behaves the same way as the model.</p><p>Before we start there are multiple types of model-based test. The one we will explore is state chart powered model-based testing. This is an early exploration of the ideas around model-based testing and as such will develop over time.</p><p>I will start by introducing the pieces of a model-based test and how they fit together, then go through what is being tested.</p><h3>What do we need for a model-based test</h3><p>To write a model based test for a component, you need a state chart. This state chart will define the states of your component, and the events that transfer between the states.</p><p>This state chart was created using <a href="https://xstate.js.org/">XState</a>, and it's visualiser:</p><p><img src="https://res.cloudinary.com/lazydayed/image/upload/v1554714019/Devtings/light-machine.png" alt="light machine state chart, going from green to amber to red with switch events and a stop event to go straight to red" title="Light state chart"></p><p>Then from the state chart using graph theory you are able to generate a series of paths, that step through through each state via an event. The above state chart generates the following paths:</p><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LR<br>G1<span class="token text string">[green]</span><br><br>G2<span class="token text string">[green]</span> <span class="token arrow operator">--></span><span class="token label property">|SWITCH|</span>A2<span class="token text string">[amber]</span><br><br>G4<span class="token text string">[green]</span> <span class="token arrow operator">--></span><span class="token label property">|SWITCH|</span>A4<span class="token text string">[amber]</span><br>A4 <span class="token arrow operator">--></span><span class="token label property">|SWITCH|</span>R4<span class="token text string">[Red]</span><br><br>G3<span class="token text string">[green]</span> <span class="token arrow operator">--></span><span class="token label property">|SWITCH|</span>A3<span class="token text string">[amber]</span><br>A3 <span class="token arrow operator">--></span><span class="token label property">|STOP|</span>R3<span class="token text string">[red]</span><br><br>G5<span class="token text string">[green]</span> <span class="token arrow operator">--></span><span class="token label property">|STOP|</span>R5<span class="token text string">[red]</span><br></code></pre><p>Once we have the paths, we need a way of interacting with the component to trigger the events that are on each step of the path. This is where something like <a href="https://testing-library.com/">DOM-testing-library</a> is very useful. We can say given the state is <code>Green</code> and when the event is <code>Switch</code> then find the Switch button on the page a press it.</p><p>A lookup can work here:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> triggerEvents <span class="token operator">=</span> <span class="token punctuation">{</span><br>  green<span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token function-variable function">SWITCH</span><span class="token operator">:</span> <span class="token parameter">container</span> <span class="token operator">=></span> <br>      fireEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">"Switch"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br></code></pre><p>This leaves us with the job of validating that we are in the correct state after each event. This is where we use the testing library to confirm that we are in the state we expect.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> compare <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token function-variable function">green</span><span class="token operator">:</span> <span class="token parameter">container</span> <span class="token operator">=></span> <br>    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByTestId</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">"state-value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">"green"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br></code></pre><p>Run your tests iterating through each path and you will cover the routes through your application.</p><h3>What got tested?</h3><p>Firstly we have tested that the the events are triggered as expected. In the above example we are expecting to find an element with the word &quot;Switch&quot; and for that element to be clickable.</p><p>Are first test is: &quot;Do the triggers we expect exist in the component&quot;.</p><p>This leads onto a side-effect of the trigger testing. If you have an event but no way of triggering it, then those tests won't run.</p><p>The next test is that the states transition as expected. If your event trigger takes you to somewhere not expected. Then the test will fail.</p><p>The next overall test is: &quot;Do the triggers transition the state correctly&quot;.</p><h3>What does it look like in practice</h3><p>Here is an early example using XState and react-testing-library to model, implement and test a simple state chart. It generates the paths using <code>@xstate/graph</code> and then uses a lookup for the events and the state validation.</p><iframe src="https://codesandbox.io/embed/v0o9xv4n67?fontsize=14" title="xstate model-based testing" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe><h3>Conclusion</h3><p>Model-based testing is a fascinating tool, generating the paths through an application or component and then confirming the implementation traverses the paths correctly is a powerful way to test a code-base.</p><h3>Thoughts from me</h3><p>This is a topic I am still in the early stages of exploring and leaning heavily on XState and <a href="http://graphwalker.github.io">GraphWalker</a> for my understanding. I need to cover more complex charts, fit in context, understand how to use example and property based testing for more complex interactions, e.g. things like forms; and how to treat multiple transition event triggers for the same path, e.g. testing mouse and keyboard interactions.</p></article></div><footer><nav><div><div><img src="https://www.gravatar.com/avatar/7b1630c267230ec687dd7133d3a2e2b3?s=80" class="logo__img" alt="Adam Sanderson"></div>A front-end developer based out of Hastings, UK</div><a href="/">Home<a href="https://github.com/adsanderson" title="Github"> github </a><a href="https://twitter.com/lazydayed" title="Twitter">twitter </a><a href="mailto:adam+site@adamsanderson.co.uk" rel="me">email</a></a></nav></footer><script src="/static/js/alpine.js"></script></body></html>